<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registrar NF de Sa√≠da</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      overflow-x: hidden;
    }

    .sidebar {
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      width: 240px;
      background-color: rgb(136, 2, 2);
      padding-top: 0;
    }

    .sidebar a {
      padding: 15px;
      display: block;
      color: white;
      text-decoration: none;
    }

    .sidebar a:hover {
      background-color: #961414;
    }

    .content {
      margin-left: 240px;
      padding: 20px;
    }

    .custom-card {
      border: 3px solid #880202;
      border-radius: 12px;
      padding: 30px;
      background-color: #fff;
      position: relative;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .custom-title {
      position: absolute;
      top: -14px;
      left: 20px;
      background-color: white;
      padding: 0 15px;
      color: #880202;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Sidebar do index -->
  <div class="sidebar" id="sidebar">
    <img src="https://www.radioscan.com.br/cliente_files/img/empresa/banner-empresa-06.jpg" alt="Logo" style="height: 67.5px; width: 100%;">
    <b><a href="index.html">üè† In√≠cio</a></b>
    <a href="registrar.html">‚ûï Cadastrar R√°dio</a>
    <a href="excluir.html">‚ùå Excluir R√°dio</a>
    <a href="estoque.html">üì¶ Estoque</a>
    <a href="saida.html">üì§ NF de Sa√≠da</a>
    <a href="entrada.html">üì• Retorno de Loca√ß√£o</a>
    <a href="extrato.html">üìÑ Extrato de NF</a>
    <a href="historico.html">üìö Hist√≥rico de R√°dio</a>
    <a href="#" id="logout-link">üö™ Sair</a>
  </div>

  <!-- Conte√∫do principal -->
  <div class="content">
    <div class="container mt-3">
      <div class="custom-card">
        <div class="custom-title">REGISTRAR NF DE SA√çDA</div>

        <form id="formSaida" class="pt-4">
          <div class="row mb-3">
            <div class="col">
              <label for="nfNumero" class="form-label">N√∫mero da NF</label>
              <input type="text" class="form-control" id="nfNumero" required />
            </div>
            <div class="col">
              <label for="cliente" class="form-label">Cliente</label>
              <input type="text" class="form-control" id="cliente" required />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col">
              <label for="dataSaida" class="form-label">Data de Sa√≠da</label>
              <input type="date" class="form-control" id="dataSaida" required />
            </div>
            <div class="col">
              <label for="previsaoRetorno" class="form-label">Previs√£o de Retorno</label>
              <input type="date" class="form-control" id="previsaoRetorno" />
            </div>
          </div>

          <h5>Adicionar R√°dios √† NF</h5>
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="radioSerie" placeholder="N√∫mero de S√©rie" />
            <button type="button" class="btn btn-outline-danger" id="btnAdicionar">Adicionar R√°dio</button>
          </div>

          <table class="table table-bordered" id="tabelaRadios">
            <thead class="table-light">
              <tr>
                <th>Modelo</th>
                <th>N√∫mero de S√©rie</th>
                <th>Patrim√¥nio</th>
                <th>Frequ√™ncia</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <button type="submit" class="btn btn-danger">Salvar NF de Sa√≠da</button>

          <div id="mensagem" class="mt-3"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    const token = localStorage.getItem('token');
    const permissoes = JSON.parse(localStorage.getItem('permissoes') || '[]');

    if (!token || (!permissoes.includes('saida') && !permissoes.includes('admin'))) {
      alert('Acesso negado. Fa√ßa login com uma conta autorizada.');
      window.location.href = 'index.html';
    }

    if (permissoes.includes('admin')) {
      const adminLink = document.createElement('a');
      adminLink.href = 'admin.html';
      adminLink.innerHTML = '‚öôÔ∏è Administra√ß√£o';
      const sidebar = document.getElementById('sidebar');
      const logoutLink = document.getElementById('logout-link');
      sidebar.insertBefore(adminLink, logoutLink);
    }

    document.getElementById('logout-link').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('permissoes');
      window.location.href = 'login.html';
    });

    const tabelaBody = document.querySelector('#tabelaRadios tbody');
    const radiosAdicionados = new Set();

    document.getElementById('formSaida').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && e.target.type !== 'submit') {
        e.preventDefault();
      }
    });

    document.getElementById('btnAdicionar').addEventListener('click', async () => {
      const numeroSerie = document.getElementById('radioSerie').value.trim();
      if (!numeroSerie) return;

      try {
        const res = await fetch('http://localhost:3000/radios', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Falha ao buscar r√°dios');
        const radios = await res.json();
        const radio = radios.find(r => r.numeroSerie === numeroSerie);

        if (!radio) return alert('R√°dio n√£o encontrado.');
        if (radio.status === 'Ocupado') return alert('Este r√°dio est√° OCUPADO.');
        if (radiosAdicionados.has(numeroSerie)) return alert('R√°dio j√° adicionado.');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${radio.modelo}</td>
          <td data-numero-serie="${radio.numeroSerie}">${radio.numeroSerie}</td>
          <td>${radio.patrimonio}</td>
          <td>${radio.frequencia}</td>
        `;
        tabelaBody.appendChild(tr);
        radiosAdicionados.add(numeroSerie);
        document.getElementById('radioSerie').value = '';
      } catch (err) {
        alert('Erro ao buscar r√°dios.');
      }
    });

    function dataEhValida(isoDate) {
      if (!isoDate) return false;
      const data = new Date(isoDate);
      return !isNaN(data.getTime());
    }

    document.getElementById('formSaida').addEventListener('submit', async function (e) {
      e.preventDefault();

      const nfNumero = document.getElementById('nfNumero').value.trim();
      const cliente = document.getElementById('cliente').value.trim();
      const dataSaida = document.getElementById('dataSaida').value;
      const previsaoRetorno = document.getElementById('previsaoRetorno').value;

      const hoje = new Date();
      const dataSaidaObj = new Date(dataSaida);
      const minData = new Date('2000-01-01');

      if (!dataEhValida(dataSaida)) return alert('Data de sa√≠da inv√°lida.');
      if (dataSaidaObj > hoje) return alert('A data de sa√≠da n√£o pode ser no futuro.');
      if (dataSaidaObj < minData) return alert('A data de sa√≠da n√£o pode ser anterior a 01/01/2000.');

      if (previsaoRetorno) {
        const dataPrevRetornoObj = new Date(previsaoRetorno);
        if (!dataEhValida(previsaoRetorno)) return alert('Previs√£o de retorno inv√°lida.');
        if (dataPrevRetornoObj < dataSaidaObj) return alert('Previs√£o de retorno n√£o pode ser anterior √† data de sa√≠da.');
      }

      const radiosSaida = Array.from(tabelaBody.querySelectorAll('td[data-numero-serie]')).map(td => td.dataset.numeroSerie);

      const res = await fetch('http://localhost:3000/nf/saida', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ nfNumero, cliente, dataSaida, previsaoRetorno, radiosSaida })
      });

      const data = await res.json();
      const mensagem = document.getElementById('mensagem');
      mensagem.textContent = data.message || 'Erro ao registrar NF.';
      mensagem.className = res.ok ? 'alert alert-success' : 'alert alert-danger';

      if (res.ok) {
        e.target.reset();
        tabelaBody.innerHTML = '';
        radiosAdicionados.clear();
      }
    });
  </script>
</body>
</html>
