<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hist√≥rico do R√°dio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      overflow-x: hidden;
    }
    .sidebar {
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      width: 240px;
      background-color: rgb(136, 2, 2);
      padding-top: 0;
    }
    .sidebar a {
      padding: 15px;
      display: block;
      color: white;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #961414;
    }
    .content {
      margin-left: 240px;
      padding: 20px;
    }
    .card {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      border: 2px solid #880202;
    }
    .titulo-embutido {
      position: absolute;
      top: -14px;
      left: 20px;
      background-color: white;
      padding: 0 15px;
      color: #880202;
      font-weight: bold;
    }
    #numeroSerie {
      font-size: 1.2rem;
      height: 55px;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <img src="https://www.radioscan.com.br/cliente_files/img/empresa/banner-empresa-06.jpg" alt="Logo" style="height: 67.5px; width: 100%;">
    <b><a href="index.html">üè† In√≠cio</a></b>
    <a href="registrar.html">‚ûï Cadastrar R√°dio</a>
    <a href="excluir.html">‚ùå Excluir R√°dio</a>
    <a href="estoque.html">üì¶ Estoque</a>
    <a href="saida.html">üì§ NF de Sa√≠da</a>
    <a href="entrada.html">üì• Retorno de Loca√ß√£o</a>
    <a href="extrato.html">üìÑ Extrato de NF</a>
    <a href="historico.html">üìö Hist√≥rico de R√°dio</a>
    <a href="#" id="logout-link">üö™ Sair</a>
  </div>

  <!-- Conte√∫do -->
  <div class="content">
    <div class="position-relative card">
      <div class="titulo-embutido">HIST√ìRICO DO R√ÅDIO</div>
      <div class="pt-3">
        <div class="mb-4">
          <label for="numeroSerie" class="form-label"><b>N√∫mero de S√©rie</b></label>
          <input type="text" id="numeroSerie" class="form-control" placeholder="Digite o n√∫mero de s√©rie" />
        </div>
        <button id="btnBuscar" class="btn btn-danger mb-4">Buscar Hist√≥rico</button>
        <a href="index.html" class="btn btn-danger mb-4 ms-2">Voltar ao Menu</a>
        <div id="resultadoHistorico"></div>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ Verifica token e permiss√µes
    const token = localStorage.getItem('token');
    const permissoes = JSON.parse(localStorage.getItem('permissoes') || '[]');

    if (!token || (!permissoes.includes('historico') && !permissoes.includes('admin'))) {
      alert('Acesso negado. Fa√ßa login com uma conta autorizada.');
      window.location.href = 'index.html';
    }

    document.getElementById('logout-link').addEventListener('click', function (e) {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('permissoes');
      window.location.href = 'login.html';
    });

    document.getElementById('btnBuscar').addEventListener('click', async () => {
      const numeroSerie = document.getElementById('numeroSerie').value.trim();
      const resultado = document.getElementById('resultadoHistorico');
      resultado.innerHTML = '';

      if (!numeroSerie) {
        resultado.innerHTML = '<div class="alert alert-warning">Informe um n√∫mero de s√©rie.</div>';
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/extrato/${numeroSerie}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!res.ok) {
          resultado.innerHTML = '<div class="alert alert-info">Hist√≥rico n√£o encontrado ou acesso negado.</div>';
          return;
        }

        const historico = await res.json();

        if (!historico.length) {
          resultado.innerHTML = '<div class="alert alert-info">Nenhum hist√≥rico encontrado para este n√∫mero de s√©rie.</div>';
          return;
        }

        let html = `
          <table class="table table-bordered">
            <thead class="table-danger">
              <tr>
                <th>NF</th>
                <th>Cliente</th>
                <th>Data de Sa√≠da</th>
                <th>Previs√£o de Retorno</th>
                <th>Data de Retorno</th>
              </tr>
            </thead>
            <tbody>
        `;

        historico.forEach(nf => {
          html += `
            <tr>
              <td>${nf.nfNumero}</td>
              <td>${nf.cliente}</td>
              <td>${nf.dataSaida ? new Date(nf.dataSaida).toLocaleDateString() : '-'}</td>
              <td>${nf.previsaoRetorno ? new Date(nf.previsaoRetorno).toLocaleDateString() : '-'}</td>
              <td>${nf.dataEntrada ? new Date(nf.dataEntrada).toLocaleDateString() : '-'}</td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        resultado.innerHTML = html;

      } catch (err) {
        console.error(err);
        resultado.innerHTML = '<div class="alert alert-danger">Erro ao buscar hist√≥rico.</div>';
      }
    });
  </script>
</body>
</html>
